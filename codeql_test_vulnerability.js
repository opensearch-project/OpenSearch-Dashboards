/*
 * Copyright OpenSearch Contributors
 * SPDX-License-Identifier: Apache-2.0
 */

// CodeQL Test: Test the ACTUAL vulnerability pattern from your assessment
// This mimics the lodash.get -> math.evaluate RCE vulnerability

import _ from 'lodash';
import { evaluate } from './src/plugins/vis_type_timeseries/server/lib/vis_data/response_processors/series/evaluate';

function testPrototypePollutionRCE(userControlledRow, userControlledMetric) {
  // Step 1: Vulnerable lodash.get usage (exactly like your real vulnerability)
  const result = _.get(userControlledRow, `${userControlledMetric.id}.${userControlledMetric.key}`);

  // Step 2: Flow to MathJS evaluation (the RCE vector)
  // This should be flagged as dangerous data flow by CodeQL
  const expression = `result + 1`; // Contains the result from _.get
  const scope = { result }; // Scope contains the potentially polluted data

  // Step 3: The actual code execution vulnerability
  return evaluate(expression, scope);
}

// Another test: Direct property path manipulation
function testDirectPrototypePollution(userInput) {
  const path = userInput.path; // Could be "__proto__.constructor"
  const obj = { data: {} };

  // This pattern should be detected by CodeQL
  const dangerous = _.get(obj, path);
  return evaluate(dangerous, {});
}

// Export to make it "real" code that CodeQL will analyze
export { testPrototypePollutionRCE, testDirectPrototypePollution };
